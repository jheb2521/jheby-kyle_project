<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>QUPAL â€” Frontend Mock</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div class="app">
      <header class="topbar">
        <div class="topbar-inner">
          <div class="logo">
            <!-- circle logo -->
            <svg width="52" height="52" viewBox="0 0 52 52" aria-hidden="true">
              <circle cx="26" cy="26" r="24" fill="#6fe6e6" />
              <rect x="20" y="20" width="12" height="8" rx="2" fill="#ffffff" />
              <circle cx="34" cy="14" r="4" fill="#ffffff" />
            </svg>
          </div>
          <div class="brand">
            <div class="brand-title">QUPAL</div>
            <div class="brand-sub">Your Thrift Shopping Assistant</div>
          </div>
        </div>
      </header>

      <main class="chat-area">
        <div class="card">
          <div id="messages" class="messages">
            <div class="message-row">
              <div class="avatar avatar-assistant">Q</div>
              <div class="bubble bubble-assistant">
                Hello! I'm QUPAL, your thrift shopping AI assistant. I can help
                you find amazing second-hand treasures, identify vintage items,
                estimate values, and give tips on thrifting. What are you
                looking for today?
              </div>
            </div>
          </div>
        </div>
      </main>

      <div class="input-bar">
        <form id="input-form" class="input-form">
          <input
            id="message-input"
            class="text-input"
            placeholder="Type your message..."
            autocomplete="off"
          />
          <button type="submit" class="send-btn" aria-label="Send">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path d="M3 11L21 3L14 21L11 14L3 11Z" fill="white" />
            </svg>
          </button>
        </form>
      </div>
    </div>

    <script>
      // Simple front-end message stacking + rule-based reply (mirrors Python rule set)
      const messagesEl = document.getElementById("messages");
      const form = document.getElementById("input-form");
      const input = document.getElementById("message-input");

      function appendMessage(text, sender = "assistant") {
        const row = document.createElement("div");
        row.className =
          "message-row " + (sender === "assistant" ? "row-left" : "row-right");

        if (sender === "assistant") {
          const avatar = document.createElement("div");
          avatar.className = "avatar avatar-assistant";
          avatar.textContent = "Q";
          row.appendChild(avatar);

          const bubble = document.createElement("div");
          bubble.className = "bubble bubble-assistant";
          bubble.textContent = text;
          row.appendChild(bubble);
        } else {
          const bubble = document.createElement("div");
          bubble.className = "bubble bubble-user";
          bubble.textContent = text;
          row.appendChild(bubble);
        }

        messagesEl.appendChild(row);
        // scroll to bottom
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      // Ensure messages container is scrolled to top/bottom appropriately on load
      messagesEl.scrollTop = messagesEl.scrollHeight;

      async function tryServerReply(text, extra = {}) {
        try {
          const body = Object.assign({ message: text }, extra);
          const res = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          const data = await res.json();
          if (res.ok && data) return { ok: true, data };
          return {
            ok: false,
            error: data && data.error ? data.error : "Server error",
          };
        } catch (e) {
          console.warn("Server request failed:", e);
          return { ok: false, error: "Network or server error" };
        }
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const v = input.value.trim();
        if (!v) return;
        appendMessage(v, "user");
        input.value = "";
        // Request must come from the server
        const res = await tryServerReply(v);
        if (res.ok) {
          const data = res.data;
          setTimeout(
            () => appendMessage(data.reply || "...", "assistant"),
            300
          );
          if (data.choices && Array.isArray(data.choices)) {
            // render choice buttons under the assistant message
            const container = document.createElement("div");
            container.className = "choice-container";
            data.choices.forEach((choice) => {
              const btn = document.createElement("button");
              btn.className = "choice-btn";
              btn.textContent = choice;
              btn.addEventListener("click", async () => {
                appendMessage(choice, "user");
                // send selection to server
                const sel = await tryServerReply("", {
                  action: "select",
                  selection: choice,
                });
                if (sel.ok) {
                  appendMessage(
                    sel.data.reply || "No details available.",
                    "assistant"
                  );
                } else {
                  appendMessage(
                    "Server error when fetching selection.",
                    "assistant"
                  );
                }
                container.remove();
              });
              container.appendChild(btn);
            });
            messagesEl.appendChild(container);
            messagesEl.scrollTop = messagesEl.scrollHeight;
          }
        } else {
          setTimeout(
            () =>
              appendMessage(
                "Server unavailable or not configured. Set OPENAI_API_KEY on the server and restart.",
                "assistant"
              ),
            300
          );
        }
      });
    </script>
  </body>
</html>
